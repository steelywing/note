"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[9568],{14357:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>d});var s=r(75366),a=r(26192);const o={tags:["Nginx","Proxy"]},i="Proxy",t={id:"Note/Nginx/Proxy",title:"Proxy",description:"Ref: Nginx reverse proxy",source:"@site/docs/Note/Nginx/Proxy.md",sourceDirName:"Note/Nginx",slug:"/Note/Nginx/Proxy",permalink:"/note/Note/Nginx/Proxy",draft:!1,unlisted:!1,editUrl:"https://github.com/steelywing/note/edit/master/docs/Note/Nginx/Proxy.md",tags:[{label:"Nginx",permalink:"/note/tags/nginx"},{label:"Proxy",permalink:"/note/tags/proxy"}],version:"current",frontMatter:{tags:["Nginx","Proxy"]},sidebar:"note",previous:{title:"Maintenance mode",permalink:"/note/Note/Nginx/Maintenance"},next:{title:"Redirect / Rewrite",permalink:"/note/Note/Nginx/Rewrite"}},l={},d=[{value:"If <code>proxy_pass</code> with URI",id:"if-proxy_pass-with-uri",level:2},{value:"If <code>proxy_pass</code> without URI",id:"if-proxy_pass-without-uri",level:2},{value:"Header",id:"header",level:2},{value:"Error",id:"error",level:2},{value:"SSL/TLS offloading",id:"ssltls-offloading",level:2},{value:"WebSocket",id:"websocket",level:2},{value:"Load balancing",id:"load-balancing",level:2},{value:"Real (Client) IP address",id:"real-client-ip-address",level:2},{value:"502 Bad Gateway",id:"502-bad-gateway",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"proxy",children:"Proxy"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"proxy_pass <scheme>://<host>[:port][/<URI>];\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/",children:"Nginx reverse proxy"})]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"if-proxy_pass-with-uri",children:["If ",(0,s.jsx)(n.code,{children:"proxy_pass"})," with URI"]}),"\n",(0,s.jsxs)(n.p,{children:["The part of URI matching the location is replaced by ",(0,s.jsx)(n.code,{children:"proxy_pass"})," URI"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"location /path/ {\n    proxy_pass http://www.example.com/app/;\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Request ",(0,s.jsx)(n.code,{children:"/path/page.html"})," will be proxy to ",(0,s.jsx)(n.code,{children:"http://www.example.com/app/page.html"})]}),"\n",(0,s.jsxs)(n.li,{children:["Prefix ",(0,s.jsx)(n.code,{children:"/path/"})," will be replaced by ",(0,s.jsx)(n.code,{children:"/app/"})]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"if-proxy_pass-without-uri",children:["If ",(0,s.jsx)(n.code,{children:"proxy_pass"})," without URI"]}),"\n",(0,s.jsx)(n.p,{children:"The request URI is passed to the server same as client request"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"location /path/ {\n    proxy_pass http://www.example.com;\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Request ",(0,s.jsx)(n.code,{children:"/path/page.html"})," will be proxy to ",(0,s.jsx)(n.code,{children:"http://www.example.com/path/page.html"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"header",children:"Header"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://nginx.org/en/docs/http/ngx_http_proxy_module.html#var_proxy_add_x_forwarded_for",children:(0,s.jsx)(n.code,{children:"X-Forwarded-For"})})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:'location / {\n    # Set "Host" header to the $host in request\n    proxy_set_header Host $host;\n\n    # Set "X-Real-IP" header to client IP address\n    proxy_set_header X-Real-IP $remote_addr;\n\n    # Add client IP address to "X-Forwarded-For" header\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    \n    proxy_pass http://localhost:8000;\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"error",children:"Error"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-log",children:"an upstream response is buffered to a temporary file /var/cache/nginx/proxy_temp/XXXXXX while reading upstream\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://support.f5.com/csp/article/K48373902",children:"K48373902"})]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Method 1"}),"\n",(0,s.jsx)(n.p,{children:"Increase both parameters by factor of two until warning stop appearing"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"location / {\n    proxy_buffers 16 16k;\n    proxy_buffer_size 16k;\n\n    proxy_pass http://localhost:8000;\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Method 2"}),"\n",(0,s.jsx)(n.p,{children:"Disable buffering"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"location / {\n    proxy_buffering off;\n\n    proxy_pass http://localhost:8000;\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"server {\n    listen 80;\n    server_name www.example.com;\n\n    location / {\n        proxy_pass http://backends;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"ssltls-offloading",children:"SSL/TLS offloading"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://www.nginx.com/blog/nginx-ssl/",children:"SSL/TLS Offloading, Encryption, and Certificates with NGINX and NGINX Plus"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"server {\n    listen 443 ssl;\n    server_name www.example.com;\n\n    # The certificate file\n    # Support chained certificate\n    ssl_certificate www.example.com.crt;\n\n    # The private key file\n    ssl_certificate_key www.example.com.key;\n\n    location / {\n        proxy_pass http://10.0.0.1;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"websocket",children:"WebSocket"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"/note/Note/Nginx/WebSocket",children:"WebSocket Proxy"})}),"\n",(0,s.jsx)(n.h2,{id:"load-balancing",children:"Load balancing"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"/note/Note/Nginx/LoadBalancing",children:"Load balancing"})}),"\n",(0,s.jsx)(n.h2,{id:"real-client-ip-address",children:"Real (Client) IP address"}),"\n",(0,s.jsxs)(n.p,{children:["Set ",(0,s.jsx)(n.code,{children:"$remote_addr"})," and ",(0,s.jsx)(n.code,{children:"$remote_port"})," using header"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"# set_real_ip_from  <proxy server IP address>[/<CIDR>];\n# Trusted address\nset_real_ip_from  10.0.0.1;\n\n# by default, Nginx use X-Real-IP header to set $remote_addr\n\n# Use X-Forwarded-For header to set $remote_addr\nreal_ip_header    X-Forwarded-For;\nreal_ip_recursive on;\n\n# Use X-Real-IP header to set $remote_addr\nreal_ip_header    X-Real-IP;\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://nginx.org/en/docs/http/ngx_http_realip_module.html",children:"ngx_http_realip_module"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"502-bad-gateway",children:"502 Bad Gateway"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://www.nginx.com/blog/ensuring-application-availability-with-f5-dns-load-balancer-cloud-service-and-nginx-plus/",children:"Ensuring Application Availability with F5 DNS Load Balancer Cloud Service and NGINX Plus"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["If Nginx cannot get response from backend server, Nginx will return ",(0,s.jsx)(n.strong,{children:"502 Bad Gateway"})]})]})}function h(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},26192:(e,n,r)=>{r.d(n,{Z:()=>t,a:()=>i});var s=r(97049);const a={},o=s.createContext(a);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);
"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[1983],{84083:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>d,toc:()=>o});var s=i(75366),l=i(26192);const r={},a="Samba",d={id:"Linux/Samba",title:"Samba",description:"Samba / SMB / Server Message Block",source:"@site/docs/Linux/Samba.md",sourceDirName:"Linux",slug:"/Linux/Samba",permalink:"/note/Linux/Samba",draft:!1,unlisted:!1,editUrl:"https://github.com/steelywing/note/edit/master/docs/Linux/Samba.md",tags:[],version:"current",frontMatter:{},sidebar:"linux",previous:{title:"SSH",permalink:"/note/Linux/SSH"},next:{title:"Service / Daemon",permalink:"/note/Linux/Service"}},c={},o=[{value:"<code>realm</code> CLI",id:"realm-cli",level:2},{value:"List <code>realm</code> command",id:"list-realm-command",level:3},{value:"Discover realm",id:"discover-realm",level:3},{value:"Join realm",id:"join-realm",level:3},{value:"List realm",id:"list-realm",level:3},{value:"Leave realm",id:"leave-realm",level:3},{value:"Clear samba <code>idmap</code> cache",id:"clear-samba-idmap-cache",level:2},{value:"Kerberos",id:"kerberos",level:2},{value:"Test and dump Samba config",id:"test-and-dump-samba-config",level:2},{value:"Reload config",id:"reload-config",level:2},{value:"Check domain / WinBind user",id:"check-domain--winbind-user",level:2},{value:"List WinBind users",id:"list-winbind-users",level:2},{value:"Enable Extended ACL Support",id:"enable-extended-acl-support",level:2},{value:"Audit",id:"audit",level:2},{value:"Samba member server (ADS) config",id:"samba-member-server-ads-config",level:2}];function t(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"samba",children:"Samba"}),"\n",(0,s.jsx)(n.p,{children:"Samba / SMB / Server Message Block"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"File Server"}),"\n",(0,s.jsx)(n.li,{children:"Member Server"}),"\n",(0,s.jsx)(n.li,{children:"Active Directory Domain Controller"}),"\n",(0,s.jsxs)(n.li,{children:["Support ",(0,s.jsx)(n.code,{children:"idmap"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["WinBind","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"More compatible"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://sssd.io/",children:"SSSD"})," (",(0,s.jsx)(n.a,{href:"https://access.redhat.com/articles/4355391",children:"Not fully support"}),")","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"SSSD mainly for Linux joining AD, use AD account to login Linux"}),"\n",(0,s.jsx)(n.li,{children:"Newer than WinBind"}),"\n",(0,s.jsx)(n.li,{children:"More secure"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{}),(0,s.jsx)(n.th,{})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ID / UID"}),(0,s.jsx)(n.td,{children:"Linux ID of user"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SID"}),(0,s.jsx)(n.td,{children:"Windows ID of user"})]})]})]}),"\n",(0,s.jsxs)(n.h2,{id:"realm-cli",children:[(0,s.jsx)(n.code,{children:"realm"})," CLI"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://ubuntu.com/server/docs/samba-active-directory",children:"Member server in an Active Directory domain"})]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Discover / Join / Leave / List realm (domain)"}),"\n",(0,s.jsx)(n.li,{children:"Use to auto setup SSSD / SMB / Kerberos config"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"realm"})," use kerberos credential cache"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"list-realm-command",children:["List ",(0,s.jsx)(n.code,{children:"realm"})," command"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"realm\n"})}),"\n",(0,s.jsx)(n.h3,{id:"discover-realm",children:"Discover realm"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"# realm discover [-v] [<realm>]\nrealm discover -v\n"})}),"\n",(0,s.jsx)(n.h3,{id:"join-realm",children:"Join realm"}),"\n",(0,s.jsx)(n.p,{children:"Join with default software (SSSD)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"# realm join [-v] [-U <user>] <realm>\nrealm join -v -U Administrator example.com\n"})}),"\n",(0,s.jsx)(n.p,{children:"Join with Samba and WinBind"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If join successful, ",(0,s.jsx)(n.code,{children:"realm"})," will update ",(0,s.jsx)(n.code,{children:"/etc/samba/smb.conf"}),", and other config"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"realm join -v --membership-software=samba --client-software=winbind example.com\n"})}),"\n",(0,s.jsx)(n.p,{children:"If join failed, try clear kerberos tickets"}),"\n",(0,s.jsx)(n.h3,{id:"list-realm",children:"List realm"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"realm list\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"example.com\n  type: kerberos\n  realm-name: EXAMPLE.COM\n  domain-name: example.com\n  configured: kerberos-member\n  server-software: active-directory\n  client-software: winbind\n  required-package: libnss-winbind\n  required-package: winbind\n  required-package: libpam-winbind\n  required-package: samba-common-bin\n  login-formats: %U\n  login-policy: allow-any-login\n"})}),"\n",(0,s.jsx)(n.h3,{id:"leave-realm",children:"Leave realm"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"# realm leave [-v] [<realm>]\nrealm leave\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"clear-samba-idmap-cache",children:["Clear samba ",(0,s.jsx)(n.code,{children:"idmap"})," cache"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://lists.samba.org/archive/samba/2020-November/233323.html",children:"ID Mapping"})]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Need to clear after changing ",(0,s.jsx)(n.code,{children:"idmap"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"systemctl stop winbind smbd\nnet cache flush\nsystemctl start winbind smbd\n"})}),"\n",(0,s.jsx)(n.h2,{id:"kerberos",children:"Kerberos"}),"\n",(0,s.jsx)(n.p,{children:"List Kerberos cached tickets"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"klist\n"})}),"\n",(0,s.jsx)(n.p,{children:"Clear Kerberos cached tickets"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"# kdestroy [-A] [-c cache_name] [-p princ_name]\nkdestroy -A\n"})}),"\n",(0,s.jsx)(n.h2,{id:"test-and-dump-samba-config",children:"Test and dump Samba config"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"testparm [-s]\n"})}),"\n",(0,s.jsx)(n.h2,{id:"reload-config",children:"Reload config"}),"\n",(0,s.jsxs)(n.admonition,{type:"caution",children:[(0,s.jsx)(n.p,{children:"This does not reload"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"smbcontrol smbd reload-config\n"})})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"systemctl restart smbd.service\n"})}),"\n",(0,s.jsx)(n.h2,{id:"check-domain--winbind-user",children:"Check domain / WinBind user"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If ",(0,s.jsx)(n.code,{children:"/etc/nsswitch.conf"})," has added ",(0,s.jsx)(n.code,{children:"winbind"}),", ",(0,s.jsx)(n.code,{children:"id"})," command can check domain user"]}),"\n",(0,s.jsxs)(n.li,{children:["Check ",(0,s.jsx)(n.code,{children:"idmap"})," info"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-conf",metastring:'title="/etc/nsswitch.conf"',children:"passwd:         files systemd winbind\ngroup:          files systemd winbind\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"# id '<domain>\\<user>'\n# id '<user>@<domain>'\nid 'EXAMPLE\\user'\nid 'user@example.com'\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"uid=11000(user) gid=10500(domain users) groups=10500(domain users)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"list-winbind-users",children:"List WinBind users"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"wbinfo -u\n"})}),"\n",(0,s.jsx)(n.h2,{id:"enable-extended-acl-support",children:"Enable Extended ACL Support"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.a,{href:"https://wiki.samba.org/index.php/Setting_up_a_Share_Using_Windows_ACLs",children:"Setting up a Share Using Windows ACLs"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[global]\nvfs objects = acl_xattr\nmap acl inherit = yes\n"})}),"\n",(0,s.jsx)(n.h2,{id:"audit",children:"Audit"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Log to ",(0,s.jsx)(n.code,{children:"syslog"})]}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.code,{children:"man vfs_audit"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[global]\n\n# Log the following Samba VFS operations:\n# connect disconnect opendir mkdir rmdir open close rename unlink chmod fchmod\n\nvfs objects = audit\n# audit:facility = local1\n# audit:priority = info\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.code,{children:"man vfs_full_audit"})]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["VFS full audit operations change in different version, even ",(0,s.jsx)(n.code,{children:"man vfs_full_audit"})," is not updated"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["If un-supported operation is set, ",(0,s.jsx)(n.code,{children:"all"})," is used"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Ref: ",(0,s.jsx)(n.code,{children:"init_bitmap()"})," in ",(0,s.jsx)(n.a,{href:"https://github.com/samba-team/samba/blob/master/source3/modules/vfs_full_audit.c",children:(0,s.jsx)(n.code,{children:"vfs_full_audit.c"})})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[global]\n\n# Log specified Samba VFS operations\n# https://www.samba.org/samba/docs/current/man-html/vfs_full_audit.8.html\n\nvfs objects = full_audit\n# Default\n# full_audit:prefix = %u|%I\n\nfull_audit:failure = connect disconnect opendir closedir mkdir rmdir open close rename unlink\nfull_audit:success = connect disconnect opendir closedir mkdir rmdir open close rename unlink\n\n# auth, authpriv, cron, daemon, kern, lpr, mail, mark, news, syslog, user, uucp, local0, ..., local7\nfull_audit:facility = local1\n\n# debug, info, notice, warning, err, crit, alert, emerg\nfull_audit:priority = info\n"})}),"\n",(0,s.jsx)(n.h2,{id:"samba-member-server-ads-config",children:"Samba member server (ADS) config"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[global]\n    security = ADS\n    realm = EXAMPLE.COM\n    workgroup = EXAMPLE\n    kerberos method = secrets and keytab\n    winbind enum users = yes\n    winbind enum groups = yes\n    winbind offline logon = Yes\n    winbind refresh tickets = Yes\n\n    # Access ID without domain\n    # `id user` = `id 'EXAMPLE\\user'`\n    winbind use default domain = Yes\n\n    idmap config EXAMPLE : range = 2000000-2999999\n    idmap config EXAMPLE : backend = rid\n    idmap config * : range = 1000000-1999999\n    idmap config * : backend = tdb\n"})})]})}function h(e={}){const{wrapper:n}={...(0,l.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(t,{...e})}):t(e)}},26192:(e,n,i)=>{i.d(n,{Z:()=>d,a:()=>a});var s=i(97049);const l={},r=s.createContext(l);function a(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);